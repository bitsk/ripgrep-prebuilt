# Based on https://github.com/BurntSushi/ripgrep/blob/master/appveyor.yml

parameters:
  target: ''
  rust_version: 'ms-stable'

steps:
- powershell: |
    gci env:*
    $REPO=node -p "require('./config.json').ripgrepRepo"
    $TREEISH=node -p "require('./config.json').ripgrepTag"
    git clone https://github.com/${REPO}.git
    cd ripgrep
    git checkout $TREEISH
  displayName: Clone ripgrep

- powershell: |
    $patches = node -p "require('../config.json').patches" | ConvertFrom-Json
    foreach ($patch in $patches) {
      git apply --ignore-whitespace --ignore-space-change ../patches/$patch
    }
  workingDirectory: ripgrep
  displayName: Apply patches
  condition: succeeded()

- task: RustInstaller@1
  inputs:
    rustVersion: ${{ parameters.rust_version }}
    toolchainFeed: https://pkgs.dev.azure.com/vscode/_packaging/RustTools/nuget/v3/index.json
    additionalTargets: ${{ parameters.target }}
  displayName: Install Rust toolchain

- task: CargoAuthenticate@0
  inputs:
    configFile: '.cargo/config.toml'
  workingDirectory: ripgrep


# - powershell: |
#     echo $env:reason
#     echo $BUILD_SOURCEVERSION
#     $env:PATH+=";C:\Users\appveyor\.cargo\bin"

#     msrustup default $env:RUST_VERSION
#     rustc -V
#     cargo -V

#     msrustup target add $env:TARGET
#   env:
#     RUST_VERSION: ${{ parameters.rust_version }}
#     TARGET: ${{ parameters.target }}
#     reason: variables['Build.Reason']
#   displayName: msrustup

- powershell: |
    $env:CFLAGS="/guard:cf /Qspectre"
    cargo build --release --target $env:TARGET --features pcre2

    cargo test --target "$TARGET" --release --verbose --all --features 'pcre2'

    pushd ..
    $this_tag=git tag -l --contains HEAD
    popd

    $name="ripgrep-${this_tag}-${env:TARGET}.zip"
    dir
    dir .\target
    dir .\target\${env:TARGET}\release\rg.exe
    Compress-Archive -Update -Path .\target\${env:TARGET}\release\rg.exe -DestinationPath $env:BUILD_ARTIFACTSTAGINGDIRECTORY\$name
    echo "##vso[task.setvariable variable=Name]$name"
  displayName: Build
  workingDirectory: ripgrep
  env:
    TARGET: ${{ parameters.target }}
  condition: succeeded()

- powershell: mkdir $(Build.ArtifactStagingDirectory)/_manifest
  displayName: Create SBOM drop folder

- task: 1ES.PublishPipelineArtifact@1
  displayName: 'Publish Pipeline Artifact'
  inputs:
    targetPath: $(Build.ArtifactStagingDirectory)/$(Name)
    artifactName: $(Name)
    sbomBuildDropPath: $(Build.ArtifactStagingDirectory)
    sbomBuildComponentPath: $(Build.SourcesDirectory)/ripgrep/target/${{ parameters.target }}/release
  condition: succeeded()
